compilers:
  c:       mpicc
  cpp:     mpicxx
  fortran: mpif90
configurations:
- name: release-cpu
  flags:
    c:       -O3
    cpp:     -O3
    fortran: -O3 -cpp -w
- name: release-gpu
  flags:
    c:       -O3
    cpp:     -O3
    fortran: -O3 -cpp -w -acc -Minfo=accel -L${CUDA:INSTALL_PATH}/lib64 -lnvToolsExt
- name: debug-cpu
  flags:
    c:       -Og -g
    cpp:     -Og -g
    fortran: -Og -g -cpp -w
- name: debug-gpu
  flags:
    c:       -Og
    cpp:     -Og
    fortran: -Og -cpp -w -acc -Minfo=accel -L${CUDA:INSTALL_PATH}/lib64 -lnvToolsExt
targets:
- name: FFTW3
  common_configuration: release-cpu
  fetch:
    method: download
    params:
      version: 3.3.10
      link:    http://www.fftw.org/fftw-${VERSION}.tar.gz
  build:
    commands:
    - ./configure ${CONFIGURE_OPTIONS} ${COMPILERS} --enable-threads --enable-mpi
    - make ${MAKE_OPTIONS} ${COMPILER_FLAGS} ${COMPILERS}
    - make install
  test: []

- name: HDF5
  common_configuration: release-cpu
  fetch:
    method: clone
    params:
      git:  https://github.com/HDFGroup/hdf5
      hash: 4aa40365623cf35643b262781f92578220c42bbb
  build:
    commands:
    - ./configure ${CONFIGURE_OPTIONS} ${COMPILERS} --enable-parallel --enable-deprecated-symbols
    - make ${MAKE_OPTIONS} ${COMPILER_FLAGS} ${COMPILERS}
    - make install prefix="${INSTALL_PATH}"
  test: []

- name: SILO
  common_configuration: release-cpu
  depends:
  - HDF5
  fetch:
    method: clone
    params:
      git:  https://github.com/LLNL/Silo
      hash: 9e3a31fbf661c4d26e9f5272287e5ff41971d117
  build:
    commands:
    - >-
      ./configure ${CONFIGURE_OPTIONS} --enable-pythonmodule --enable-optimization
      --disable-hzip --disable-fpzip --disable-silex
      --with-hdf5="${HDF5:INSTALL_PATH}/include","${HDF5:INSTALL_PATH}/lib"
      ${COMPILERS} ${COMPILER_FLAGS} CFLAGS="-O0" CPPFLAGS="-O0" FFLAGS="-O0"
    - make ${MAKE_OPTIONS}
    - make install prefix="${INSTALL_PATH}"
  test: []

- name: MFC_PreProcess
  depends: []
  fetch:
    method: source
    params:
      source: ${MFC_ROOT_PATH}/src/pre_process_code
  clean:
  - make INSTALL_PATH="${MFC_PreProcess:INSTALL_PATH}" clean
  build:
    commands:
    - >-
      make INSTALL_PATH="${MFC_PreProcess:INSTALL_PATH}"
      ${MAKE_OPTIONS} ${COMPILER_FLAGS} ${COMPILERS}
  test: []

- name: MFC_Simulation
  depends:
  - FFTW3
  fetch:
    method: source
    params:
      source: ${MFC_ROOT_PATH}/src/simulation_code
  clean:
  - make INSTALL_PATH="${MFC_Simulation:INSTALL_PATH}" clean
  build:
    commands:
    - >-
      make INSTALL_PATH="${MFC_Simulation:INSTALL_PATH}"
      ${MAKE_OPTIONS} ${COMPILER_FLAGS} ${COMPILERS}
      FFLAGS="-lfftw3 -lm -I${FFTW3:INSTALL_PATH}/include -L${FFTW3:INSTALL_PATH}/lib"
  test: []

- name: MFC_PostProcess
  depends:
  - FFTW3
  - HDF5
  - SILO
  fetch:
    method: source
    params:
      source: ${MFC_ROOT_PATH}/src/post_process_code
  clean:
  - make INSTALL_PATH="${MFC_PostProcess:INSTALL_PATH}" clean
  build:
    commands:
    - >-
      make INSTALL_PATH="${MFC_PostProcess:INSTALL_PATH}"
      ${MAKE_OPTIONS} ${COMPILER_FLAGS} ${COMPILERS}
      FFLAGS="-lfftw3 -lsiloh5 -lm -I${FFTW3:INSTALL_PATH}/include -L${FFTW3:INSTALL_PATH}/lib"
  test: []

- name: MFC
  fetch:
    method: collection
    params: null
  depends:
  - MFC_PreProcess
  - MFC_Simulation
  - MFC_PostProcess
  collection:
  build:
    commands: []
  test:
  - cd "${MFC_ROOT_PATH}" && /usr/bin/env bash "tests/checks.sh"
